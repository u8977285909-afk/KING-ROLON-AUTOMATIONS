<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="debug" content="TEST-KING-ROLON">
  <title>KING ROLON AUTOMATIONS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Estilos embebidos -->
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    .kr-body{background:#050509;color:#f3f3f3;display:flex;min-height:100vh}
    .kr-sidebar{width:260px;background:radial-gradient(circle at top,#14121a 0,#050509 60%);border-right:1px solid rgba(255,255,255,.06);padding:24px 20px;display:flex;flex-direction:column;justify-content:space-between}
    .kr-logo{display:flex;align-items:center;gap:10px;margin-bottom:30px}
    .kr-crown{font-size:32px;filter:drop-shadow(0 0 8px gold)}
    .kr-brand-main{font-weight:800;letter-spacing:2px;font-size:18px}
    .kr-brand-sub{font-size:11px;text-transform:uppercase;letter-spacing:3px;color:#b0b0b0}
    .kr-nav{display:flex;flex-direction:column;gap:10px}
    .kr-nav-item{text-decoration:none;color:#c6c6c6;padding:10px 12px;border-radius:10px;font-size:14px;transition:all .2s ease}
    .kr-nav-item:hover{background:rgba(255,255,255,.05);color:#fff}
    .kr-active{background:linear-gradient(90deg,#e0b15b,#f7e39c);color:#050509!important;font-weight:600}
    .kr-sidebar-footer{border-top:1px solid rgba(255,255,255,.06);padding-top:16px;font-size:12px}
    .kr-user-label{color:#8c8c8c;display:block;margin-bottom:4px}
    .kr-user-name{font-weight:600}
    .kr-main{flex:1;padding:24px 32px;display:flex;flex-direction:column}
    .kr-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .kr-page-title{font-size:24px;font-weight:700}
    .kr-page-subtitle{font-size:13px;color:#a0a0a0;margin-top:4px}
    .kr-header-actions{display:flex;gap:10px}
    .kr-btn{border:none;padding:8px 16px;border-radius:999px;font-size:13px;cursor:pointer;background:#22222a;color:#f3f3f3}
    .kr-btn-outline{border:1px solid rgba(255,255,255,.15)}
    .kr-btn-gold{background:linear-gradient(90deg,#e0b15b,#f7e39c);color:#050509;font-weight:600}
    .kr-content{flex:1}
    .kr-grid{display:grid;gap:18px}
    .kr-grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .kr-grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:960px){.kr-grid-3,.kr-grid-2{grid-template-columns:1fr}.kr-sidebar{display:none}}
    .kr-card{background:radial-gradient(circle at top left,#171320 0,#07060c 60%);border-radius:18px;padding:18px 18px 20px;border:1px solid rgba(255,255,255,.06);box-shadow:0 12px 30px rgba(0,0,0,.6)}
    .kr-card-title{font-size:15px;margin-bottom:10px}
    .kr-card-number{font-size:26px;font-weight:700;margin-bottom:6px}
    .kr-card-label{font-size:12px;color:#a0a0a0}
    .kr-list{list-style:none;display:flex;flex-direction:column;gap:10px;font-size:13px}
    .kr-list li{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .kr-tag{padding:4px 10px;border-radius:999px;font-size:11px;background:rgba(255,255,255,.06)}
    .kr-tag-ok{background:rgba(46,204,113,.16);color:#6ee7a0}
    .kr-tag-pending{background:rgba(241,196,15,.16);color:#f6d86b}
    .kr-tag-off{background:rgba(231,76,60,.16);color:#f58b83}
    .kr-dot{width:8px;height:8px;border-radius:999px}
    .kr-dot-ok{background:#2ecc71}.kr-dot-pending{background:#f1c40f}.kr-dot-off{background:#e74c3c}
    .kr-mt-lg{margin-top:22px}

    /* ===== Modal ===== */
    .kr-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .kr-modal{width:min(560px,92vw);background:rgba(18,18,24,.98);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px 22px 18px;box-shadow:0 25px 80px rgba(0,0,0,.6)}
    .kr-modal h3{font-size:18px;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .kr-field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .kr-field label{font-size:12px;color:#a9a9a9}
    .kr-input,.kr-select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:#f3f3f3;outline:none}
    .kr-input::placeholder{color:#8b8b8b}
    .kr-modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}
    .is-open{display:flex}
  </style>
</head>
<body class="kr-body">
  <aside class="kr-sidebar">
    <div>
      <div class="kr-logo">
        <div class="kr-crown">ðŸ‘‘</div>
        <div class="kr-brand">
          <span class="kr-brand-main">KING ROLON</span>
          <span class="kr-brand-sub">AUTOMATIONS</span>
        </div>
      </div>

      <nav class="kr-nav">
        <a href="{{ url_for('dashboard') }}" class="kr-nav-item kr-active">Dashboard</a>
        <a href="#" class="kr-nav-item">Tareas automÃ¡ticas</a>
        <a href="#" class="kr-nav-item">Conexiones</a>
        <a href="#" class="kr-nav-item">Ingresos</a>
        <a href="#" class="kr-nav-item">ConfiguraciÃ³n</a>
      </nav>
    </div>

    <div class="kr-sidebar-footer">
      <span class="kr-user-label">Conectado como</span>
      <span class="kr-user-name">KING ROLON</span>
    </div>
  </aside>

  <main class="kr-main">
    <header class="kr-header">
      <div>
        <h1 class="kr-page-title">Panel central</h1>
        <p class="kr-page-subtitle">Controla todas tus plataformas desde un solo lugar.</p>
      </div>
      <div class="kr-header-actions">
        <button class="kr-btn kr-btn-outline">Modo demo</button>
        <button id="kr-open-modal" class="kr-btn kr-btn-gold">+ Nueva automatizaciÃ³n</button>
      </div>
    </header>

    <section class="kr-content">
      {% block content %}{% endblock %}
    </section>
  </main>

  <!-- Modal: Nueva automatizaciÃ³n -->
  <div id="kr-modal-overlay" class="kr-modal-overlay" aria-hidden="true">
    <div class="kr-modal" role="dialog" aria-modal="true" aria-labelledby="kr-modal-title">
      <h3 id="kr-modal-title">âž• Nueva automatizaciÃ³n</h3>

      <div class="kr-field">
        <label for="kr-nombre">Nombre de la tarea</label>
        <input id="kr-nombre" class="kr-input" type="text" placeholder="Ej: Subir clip diario a TikTok">
      </div>

      <div class="kr-field">
        <label for="kr-plataforma">Plataforma</label>
        <select id="kr-plataforma" class="kr-select">
          <option>TikTok</option>
          <option>Facebook</option>
          <option>YouTube</option>
          <option>Twitch</option>
          <option>Global</option>
        </select>
      </div>

      <div class="kr-field">
        <label for="kr-frecuencia">Frecuencia</label>
        <input id="kr-frecuencia" class="kr-input" type="text" placeholder="Cada 24h / DespuÃ©s de cada stream">
      </div>

      <div class="kr-modal-actions">
        <button id="kr-close-modal" class="kr-btn kr-btn-outline">Cancelar</button>
        <button id="kr-save-task" class="kr-btn kr-btn-gold">Guardar</button>
      </div>
    </div>
  </div>

  <!-- JS mÃ­nimo: abrir/cerrar modal y llamar a la API correcta -->
  <script>
    (function () {
      const openBtn   = document.getElementById('kr-open-modal');
      const closeBtn  = document.getElementById('kr-close-modal');
      const overlay   = document.getElementById('kr-modal-overlay');
      const saveBtn   = document.getElementById('kr-save-task');

      function openModal(){ overlay.classList.add('is-open'); overlay.setAttribute('aria-hidden','false'); }
      function closeModal(){ overlay.classList.remove('is-open'); overlay.setAttribute('aria-hidden','true'); }
      openBtn.addEventListener('click', openModal);
      closeBtn.addEventListener('click', closeModal);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });

      async function guardarTarea() {
        const nombre     = document.getElementById('kr-nombre').value.trim();
        const plataforma = document.getElementById('kr-plataforma').value.trim();
        const frecuencia = document.getElementById('kr-frecuencia').value.trim();

        if (!nombre) { alert('Ponle un nombre a la tarea ðŸ‘‘'); return; }

        try {
          const resp = await fetch("{{ url_for('api_create_task') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombre, plataforma, frecuencia })
          });

          if (!resp.ok) {
            const text = await resp.text();
            throw new Error('HTTP '+resp.status+' â€” '+text);
          }

          closeModal();
          location.reload(); // refresca el dashboard con la nueva tarea
        } catch (err) {
          console.error(err);
          alert('No se pudo guardar la tarea. Revisa la consola.');
        }
      }
      saveBtn.addEventListener('click', guardarTarea);
    })();
  </script>
</body>
</html>
